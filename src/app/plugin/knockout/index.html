<html>
	<head>
		<script type="text/javascript" src="../../../lib/knockout.js/knockout-3.3.0.js"></script>
		<script type="text/javascript" src="../../../lib/jquery/jquery-2.1.3.js"></script>
		<script type="text/javascript" src="todo.js"></script>
	</head>
	<body>

		<input data-bind="textInput: item, event: {keypress: onEnter}" />

		<table>
			<thead>
				<tr>
				  	<th>Status</th>
				  	<th>Items</th>
				  	<th>&nbsp;</th>

				</tr>

			 </thead>
			 <tbody data-bind="foreach: items">
				  <tr>
				  		<td data-bind="click: $parent.toggle"><a href="#" data-bind="text:status"></a></td>
						<td data-bind="text: name"></td>
						<td data-bind="click: $parent.deleteItem"><a href="#">remove</a></td>
				  </tr>
			 </tbody>
		</table>

	</body>
	<script type="text/javascript">

		eval( (function(){

			var ViewModel = function(facade) {
				var self = this;

				self.item = ko.observable('');
				self.items = ko.observableArray();

				var addItemCommand = facade.getAddItemCommand();
				var removeItemCommand = facade.getRemoveItemCommand();
				var changeItemStatusCommand = facade.getChangeItemStatusCommand();

				facade.registerItemAddedCallback( function(item) {
					// Push item into list
					self.items.push( item );

					// clear existing input
					self.item('');
				});

				facade.registerItemRemovedCallback( function(item) {
					self.items.remove( item );
				});

				facade.registerItemStatusChangedCallback( function(item) {

					var match = ko.utils.arrayFirst(self.items(), function( o ) {
						 return o.guid === item.guid;
					});

					if( match ) {
						self.items.replace( match, item );
					}

				});

				self.onEnter = function(d,e) {
					if( e.key == "Enter" ) {
						var name = self.item();
						var guid = Guid.create();
						var status = "active";

						var item = new Item( name, status, guid );

						addItemCommand.execute( item );
					}

					return true;
				};


				self.toggle = function(item) {
					changeItemStatusCommand.execute( item );
				}

				self.deleteItem = function(item) {
					removeItemCommand.execute(item);
				};
			};
			
			var facade = new TodoListFacade();
			ko.applyBindings( new ViewModel(facade) );
		})() );

	</script>
</html>
